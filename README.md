# 天听计划 RAG 个人知识库项目

## 项目功能

- 智能分块处理：自动将小说内容按章节进行语义分块，保留上下文关联
- 向量嵌入生成：使用 HuggingFace bge-m3 模型将文本转换为高维向量
- 相似性检索：利用 pgvector 数据库实现高效的余弦相似度检索
- 智能问答：结合检索到的相关文本片段和通义千问大模型，生成精准回答
- Web 交互界面：提供基于 Next.js 的网页聊天界面，方便用户进行交互式问答

## 技术栈

- 前端框架：Next.js 16
- 向量数据库：PostgreSQL + pgvector
- AI 集成：
  - LangChain.js（RAG 框架）+ Vercel AI SDK
  - HuggingFace API（文本嵌入）
  - Groq API（通义千问大模型调用）
- 数据库 ORM：Drizzle ORM

## 工作流程

1. 数据预处理：通过 chunking.ts 脚本将小说分块并生成向量嵌入
2. 向量存储：将文本块和对应嵌入存储到 pgvector 数据库
3. 查询处理：
   - 生成查询文本的向量嵌入
   - 在向量数据库中检索最相似的文本片段
   - 将检索结果和问题发送给大模型生成回答
   - 用户通过 Web 界面或脚本提出问题

## 应用场景

- 科幻小说内容智能问答和知识检索
- RAG 技术在文学作品分析中的应用示例
- 个人知识库构建与检索增强生成技术的实践项目

项目通过 Docker 提供完整的开发环境，支持本地快速部署和测试，适合学习和探索 RAG 技术的开发者使用。

## 本地开发环境启动

1. 启动 pgvector 数据库（需先安装 Docker Compose）：

```bash
docker compose up -d
```

2. 安装依赖（需先安装 pnpm）：

```bash
pnpm install
```

3. 配置环境变量：

复制 `.env.example` 为 `.env`，并填写 HuggingFace API Key 和 Groq API Key。

4. 生成并运行数据库迁移：

```
pnpm drizzle:generate && pnpm drizzle:migrate
```

5. 运行分块脚本（chunking）：

```bash
pnpm chunking
```

6. 启动开发服务器：

```bash
pnpm dev
```

或者运行查询脚本：

```bash
pnpm query
```

## 目录说明

- `app/`: Next.js App Router 目录
  - `page.tsx`: 主页聊天界面
  - `api/chat/route.ts`: 聊天 API 路由
- `components/`: React 组件
- `doc/tianting.md`: 自己的随笔小说原文（已同步个人博客 <https://www.amingdrift.com/blog/posts/tian-ting-ji-hua-luo-si-xian-jing> _仅作为测试 RAG 项目，小说设定太多，文学描写较少，可读性不高_
- `scripts/chunking.ts`: 分块与 embedding 脚本
- `scripts/query.ts`: 查询与问答脚本
- `docker-compose.yml`: 本地 pgvector 数据库

## 功能详情

### Web 聊天界面

项目提供了一个基于 Next.js 的 Web 聊天界面，位于 [`app/page.tsx`](./app/page.tsx)，具有以下特点：

- 使用 `@ai-sdk/react` 的 `useChat` hook 实现聊天功能
- 响应式设计，适配不同屏幕尺寸
- 集成常见问题下拉菜单，方便快速提问
- 支持 Markdown 渲染回答内容
- 自动滚动到底部以显示最新消息
- 动态计算消息区域高度以适应窗口大小变化

常见问题包括：

1. "“天听计划”是在哪一年正式启动的？其核心原则是什么？"
2. "丁仪发现了罗斯信号中的哪两处“地球专属”的异常细节，从而怀疑这是伪造的？"
3. "文中丁仪提到的“伪清洁鱼”比喻，想要说明什么道理？"
4. "为什么丁仪认为，即使人类文明在未来百年内技术突飞猛进，也无法对罗斯文明构成威胁？"
5. "《天听计划》如何通过“开拓者舰队”与“火种计划”的对比，体现对“黑暗森林”理论的不同应对策略？"

### 聊天 API

聊天功能的后端 API 位于 [`app/api/chat/route.ts`](./app/api/chat/route.ts)，实现了完整的 RAG 流程：

1. 接收用户消息并提取最新问题
2. 使用 HuggingFace API 生成查询文本的向量嵌入
3. 查询 pgvector 数据库，检索最相关的文本片段（TOP_K=5）
4. 构造包含检索上下文和用户问题的提示词
5. 调用 Groq API 上的通义千问大模型（qwen/qwen3-32b）生成回答
6. 返回流式响应给前端

API 使用了以下技术：

- `@huggingface/inference` 用于生成嵌入向量
- `pg` 和 `drizzle-orm` 用于数据库操作
- `@ai-sdk/groq` 用于调用大模型
- `ai` SDK 用于流式文本生成

## 说明

- embedding 通过 LangChain.js 调用 HuggingFace bge-m3 Inference API
- 所有环境（开发/生产）均用 HF API
- 数据库连接参数见 `.env.example`

## 问答效果

具体脚本请运行`pnpm query` 或 直接`pnpm dev`后在页面查看

### Q: "天听计划"是在哪一年正式启动的？其核心原则是什么？

> A: 根据提供的信息，"天听计划"是在 2020 年代初正式启动的，其核心原则是"被动监听、零主动发射"。

### Q: 丁仪发现了罗斯信号中的哪两处"地球专属"的异常细节，从而怀疑这是伪造的？

> A: 丁仪发现了两处"地球专属"的异常细节：
>
> 1. **1970 年大力神-3C 火箭事故**：该火箭因燃料阀缺陷爆炸，导致 L 波段出现 72 小时频谱空白。这一事故连 NASA 内部都极少提及，但在罗斯信号中，1970 年对应时段出现了完全相同的频段中断，甚至背景热噪声的波动模式也一致。
> 2. **1973 年苏联金星 12 号着陆器软件计时 bug**：该着陆器因一段未公开的软件错误，在触地前 0.8 秒自动关机，遥测信号末尾留下 837 毫秒的异常静默。这段数据从未进入国际数据库，仅存于莫斯科某研究所的纸质日志中，但罗斯信号在对应节点也复现了这段静默，精确至毫秒。

### Q: 文中丁仪提到的"伪清洁鱼"比喻，想要说明什么道理？

> A: 丁仪用"伪清洁鱼"的比喻，说明对方可能并非真正的同类，而是像伪清洁鱼一样，通过精准模仿人类的行为和语言来接近我们，最终却可能带来伤害。他想表达的是：对方可能并非友善的"兄弟"，而是具有潜在威胁的模仿者。

### Q: 为什么丁仪认为，即使人类文明在未来百年内技术突飞猛进，也无法对罗斯文明构成威胁？

> A: 丁仪认为，即使人类文明在未来百年内技术突飞猛进，也无法对罗斯文明构成威胁，是因为罗斯文明的技术层级远超人类。他指出，能够像素级模拟人类的频谱信号，并向地球精准投放，说明他们很可能早已监控地球。他们敢让人类发展百年后再公布自己的位置，表明即便人类文明突然跃升，也构不成威胁。

### Q: 《天听计划》如何通过"开拓者舰队"与"火种计划"的对比，体现对"黑暗森林"理论的不同应对策略？

> A: 《天听计划：罗斯陷阱》中，"开拓者舰队"与"火种计划"分别体现了对"黑暗森林"理论的两种不同应对策略：
>
> 1. **开拓者舰队**：  
>    该计划是人类主动向宇宙扩张的象征，目标是在罗斯 128b 建立地外主权，接触并扶持"亲地球派"。它代表了一种积极进取、试图通过技术优势和政治联盟在宇宙中寻求生存与扩张的策略，类似于"黑暗森林"理论中"猎人"的角色——主动寻找并控制潜在的文明。
> 2. **火种计划**：  
>    与之相反，火种计划不追求扩张或殖民，而是以保存人类文明为终极目标。它将人类基因库、文明档案等关键信息封装于四艘飞船中，隐藏于深空，等待可能的"末日"时刻重启文明。这种策略更接近"黑暗森林"理论中"逃亡者"的选择——在未知的宇宙中隐匿自身，避免暴露，以求生存。
>
> 因此，小说通过这两个计划的对比，展现了两种截然不同的宇宙生存哲学：一种是主动出击、寻求希望；另一种则是隐忍蛰伏、保存火种。
